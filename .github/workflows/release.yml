name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-native:
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest ]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      # ------------------------
      # Read version from pom.xml (maven-help-plugin)
      # ------------------------
      - name: Resolve version & jar (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "APP_VERSION=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)" >> $GITHUB_ENV
          echo "APP_JAR=$(ls target/patchvisualizer-*.jar | head -n 1 | xargs -n1 basename)" >> $GITHUB_ENV

      - name: Resolve version & jar (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          for /f %%v in ('mvn -q -DforceStdout help:evaluate -Dexpression=project.version') do (
            echo APP_VERSION=%%v>>%GITHUB_ENV%
          )
          for %%f in (target\patchvisualizer-*.jar) do (
            echo APP_JAR=%%~nxf>>%GITHUB_ENV%
            goto :eof
          )

      # ------------------------
      # jpackage (Windows → exe)
      # ------------------------
      - name: Package with jpackage (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          jpackage ^
            --type exe ^
            --input target ^
            --main-jar %APP_JAR% ^
            --name PatchVisualizer ^
            --app-version %APP_VERSION% ^
            --icon icons\icon.ico ^
            --vendor "Tlcsdm" ^
            --win-menu ^
            --win-shortcut ^
            --dest dist

      # ------------------------
      # jpackage (Linux → deb)
      # ------------------------
      - name: Package with jpackage (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          jpackage \
            --type deb \
            --input target \
            --main-jar "${APP_JAR}" \
            --name patchvisualizer \
            --app-version "${APP_VERSION}" \
            --icon icons/icon.png \
            --dest dist

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
