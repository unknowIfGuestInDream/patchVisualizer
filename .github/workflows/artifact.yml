name: Artifact

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  upload-artifact:
    strategy:
      matrix:
        os: [ ubuntu-latest, windows-latest ]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      # ------------------------
      # Read version from pom.xml (maven-help-plugin)
      # ------------------------
      - name: Resolve version & jar (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "APP_VERSION=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)" >> $GITHUB_ENV
          echo "APP_JAR=$(ls target/patchvisualizer-*.jar | head -n 1 | xargs -n1 basename)" >> $GITHUB_ENV

      - name: Resolve version & jar (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $versionOutput = mvn -q -DforceStdout help:evaluate -Dexpression=project.version 2>$null
          $version = $versionOutput.Trim()
          if (-not $version) {
            throw "Failed to extract version from Maven"
          }
          echo "APP_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append

          $jarFiles = Get-ChildItem target\patchvisualizer-*.jar -ErrorAction SilentlyContinue
          if ($null -eq $jarFiles -or $jarFiles.Count -eq 0) {
            throw "No jar file found matching pattern target\patchvisualizer-*.jar"
          }
          $jar = $jarFiles[0].Name
          echo "APP_JAR=$jar" | Out-File -FilePath $env:GITHUB_ENV -Append

          Write-Host "Resolved APP_VERSION=$version"
          Write-Host "Resolved APP_JAR=$jar"

      # ------------------------
      # jpackage (Windows → exe)
      # ------------------------
      - name: Package with jpackage (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          jpackage ^
            --type exe ^
            --input target ^
            --main-jar %APP_JAR% ^
            --name PatchVisualizer ^
            --app-version %APP_VERSION% ^
            --icon icons\icon.ico ^
            --vendor "Tlcsdm" ^
            --win-menu ^
            --win-shortcut ^
            --dest dist

      # ------------------------
      # jpackage (Linux → deb)
      # ------------------------
      - name: Package with jpackage (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          jpackage \
            --type deb \
            --input target \
            --main-jar "${APP_JAR}" \
            --name patchvisualizer \
            --app-version "${APP_VERSION}" \
            --icon icons/icon.png \
            --dest dist

      - name: Upload packaged artifact
        uses: actions/upload-artifact@v4
        with:
          name: patchvisualizer-${{ matrix.os }}
          path: dist/*
          retention-days: 7
